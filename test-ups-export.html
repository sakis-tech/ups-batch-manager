<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS Export Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>UPS Batch Export Test</h1>
    <p>Testet die UPS-konforme Export-Funktionalität mit korrekter Feldreihenfolge und -struktur.</p>
    
    <div class="test-section">
        <h2>Test 1: UPS Field Order Verification</h2>
        <button onclick="testFieldOrder()">UPS Feldreihenfolge testen</button>
        <div id="fieldOrderResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Sample Export</h2>
        <button onclick="testSampleExport()">Test-Export generieren</button>
        <div id="sampleExportResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Validation Test</h2>
        <button onclick="testValidation()">UPS-Validierung testen</button>
        <div id="validationResult"></div>
    </div>

    <!-- Include required JavaScript files -->
    <script src="js/de/core/ups-fields.js"></script>
    <script src="js/de/core/shipment-de.js"></script>
    <script>
        // Mock toast system for testing
        window.toastSystem = {
            showSuccess: (msg) => console.log('SUCCESS:', msg),
            showError: (msg) => console.log('ERROR:', msg),
            showWarning: (msg) => console.log('WARNING:', msg),
            showLoading: (msg) => { console.log('LOADING:', msg); return 'loading-id'; },
            hideToast: (id) => console.log('HIDE:', id)
        };

        function testFieldOrder() {
            const resultDiv = document.getElementById('fieldOrderResult');
            
            try {
                // Check if UPS_FIELDS is loaded
                if (!window.UPS_FIELDS) {
                    throw new Error('UPS_FIELDS nicht geladen');
                }
                
                // Get field order from our implementation
                const ourFields = Object.keys(window.UPS_FIELDS);
                
                // Expected field order from UPS JSON specification
                const expectedFields = [
                    'Contact Name',
                    'Company or Name',
                    'Country',
                    'Address 1',
                    'Address 2',
                    'Address 3',
                    'City',
                    'State/Province/Other',
                    'Postal Code',
                    'Telephone',
                    'Extension',
                    'Residential Indicator',
                    'E-mail Address',
                    'Packaging Type',
                    'Customs Value',
                    'Weight',
                    'Length',
                    'Width',
                    'Height',
                    'Unit of Measure',
                    'Description of Goods',
                    'Documents of No Commercial Value',
                    'GNIFC (Goods not in Free Circulation)',
                    'Declared Value',
                    'Service'
                    // ... und weitere Felder
                ];
                
                let html = '<h3>Feldreihenfolge Vergleich:</h3>';
                html += `<p><strong>Anzahl Felder:</strong> ${ourFields.length}</p>`;
                
                // Check first 25 fields for order
                let orderCorrect = true;
                for (let i = 0; i < Math.min(25, expectedFields.length); i++) {
                    const expected = expectedFields[i];
                    const actual = ourFields[i];
                    const isCorrect = expected === actual;
                    if (!isCorrect) orderCorrect = false;
                    
                    html += `<div style="margin: 5px 0; ${isCorrect ? 'color: green' : 'color: red'}">`;
                    html += `${i + 1}. ${actual} ${isCorrect ? '✓' : '✗ (erwartet: ' + expected + ')'}`;
                    html += '</div>';
                }
                
                html += `<h4 style="color: ${orderCorrect ? 'green' : 'red'}">`;
                html += orderCorrect ? 'Feldreihenfolge korrekt ✓' : 'Feldreihenfolge inkorrekt ✗';
                html += '</h4>';
                
                resultDiv.innerHTML = html;
                resultDiv.className = 'test-section ' + (orderCorrect ? 'success' : 'error');
                
            } catch (error) {
                resultDiv.innerHTML = `<h3>Fehler:</h3><pre>${error.message}</pre>`;
                resultDiv.className = 'test-section error';
            }
        }

        function testSampleExport() {
            const resultDiv = document.getElementById('sampleExportResult');
            
            try {
                if (!window.shipmentManager) {
                    throw new Error('ShipmentManager nicht geladen');
                }
                
                // Create sample shipment data
                const sampleShipment = {
                    id: 1,
                    contactName: 'Max Mustermann',
                    companyName: 'Musterfirma GmbH',
                    country: 'DE',
                    address1: 'Musterstraße 123',
                    address2: '',
                    address3: '',
                    city: 'Berlin',
                    state: '',
                    postalCode: '10115',
                    telephone: '+49 30 12345678',
                    extension: '',
                    residential: '0',
                    email: 'max@musterfirma.de',
                    packagingType: '2',
                    customsValue: '',
                    weight: '2.5',
                    length: '30',
                    width: '20',
                    height: '15',
                    unitOfMeasure: 'KG',
                    goodsDescription: 'Elektronik',
                    documentsNoCommercialValue: '0',
                    gnifc: '0',
                    declaredValue: '',
                    service: '11',
                    deliveryConfirmation: '',
                    shipperRelease: '0',
                    returnOfDocument: '0',
                    saturdayDelivery: '0',
                    carbonNeutral: '0',
                    largePackage: '0',
                    additionalHandling: '0',
                    reference1: 'TEST-REF-001',
                    reference2: '',
                    reference3: '',
                    isValid: true
                };
                
                // Add sample shipment
                window.shipmentManager.shipments = [sampleShipment];
                
                // Test CSV export
                const csvExport = window.shipmentManager.exportToUPSFormat({
                    format: 'csv',
                    includeHeaders: true,
                    onlyValid: true
                });
                
                // Test SSV export  
                const ssvExport = window.shipmentManager.exportToUPSFormat({
                    format: 'ssv',
                    includeHeaders: false,
                    onlyValid: true
                });
                
                let html = '<h3>Export Beispiele:</h3>';
                html += '<h4>CSV Export (mit Headers):</h4>';
                html += `<pre>${csvExport.substring(0, 500)}...</pre>`;
                html += '<h4>SSV Export (ohne Headers, UPS-konform):</h4>';
                html += `<pre>${ssvExport.substring(0, 500)}...</pre>`;
                html += `<p><strong>CSV Länge:</strong> ${csvExport.length} Zeichen</p>`;
                html += `<p><strong>SSV Länge:</strong> ${ssvExport.length} Zeichen</p>`;
                
                // Count fields in export
                const csvLines = csvExport.split('\n');
                const headerFields = csvLines[0].split(',').length;
                const dataFields = csvLines[1] ? csvLines[1].split(',').length : 0;
                
                html += `<p><strong>Header Felder:</strong> ${headerFields}</p>`;
                html += `<p><strong>Daten Felder:</strong> ${dataFields}</p>`;
                
                const fieldsMatch = headerFields === dataFields && headerFields === Object.keys(window.UPS_FIELDS).length;
                html += `<h4 style="color: ${fieldsMatch ? 'green' : 'red'}">`;
                html += fieldsMatch ? 'Feldanzahl korrekt ✓' : 'Feldanzahl inkorrekt ✗';
                html += '</h4>';
                
                resultDiv.innerHTML = html;
                resultDiv.className = 'test-section ' + (fieldsMatch ? 'success' : 'warning');
                
            } catch (error) {
                resultDiv.innerHTML = `<h3>Fehler:</h3><pre>${error.message}</pre>`;
                resultDiv.className = 'test-section error';
            }
        }

        function testValidation() {
            const resultDiv = document.getElementById('validationResult');
            
            try {
                if (!window.shipmentManager) {
                    throw new Error('ShipmentManager nicht geladen');
                }
                
                // Test invalid shipment
                const invalidShipment = {
                    id: 1,
                    contactName: '',  // Missing for international
                    companyName: 'Test Company',
                    country: 'US',  // International destination
                    address1: '',  // Required field missing
                    city: '',  // Required field missing
                    postalCode: '12345',
                    telephone: '',  // Required for international
                    packagingType: '2',
                    weight: '',  // Required for packaging type 2
                    service: '07',  // International service
                    isValid: false
                };
                
                const validationErrors = window.shipmentManager.validateUPSBatch([invalidShipment]);
                
                let html = '<h3>Validierungsergebnisse:</h3>';
                html += `<p><strong>Anzahl Fehler:</strong> ${validationErrors.length}</p>`;
                
                if (validationErrors.length > 0) {
                    html += '<h4>Gefundene Fehler:</h4>';
                    html += '<ul>';
                    validationErrors.forEach(error => {
                        html += `<li>${error}</li>`;
                    });
                    html += '</ul>';
                }
                
                const hasExpectedErrors = validationErrors.length > 0;
                html += `<h4 style="color: ${hasExpectedErrors ? 'green' : 'red'}">`;
                html += hasExpectedErrors ? 'Validierung funktioniert ✓' : 'Validierung erkennt keine Fehler ✗';
                html += '</h4>';
                
                resultDiv.innerHTML = html;
                resultDiv.className = 'test-section ' + (hasExpectedErrors ? 'success' : 'error');
                
            } catch (error) {
                resultDiv.innerHTML = `<h3>Fehler:</h3><pre>${error.message}</pre>`;
                resultDiv.className = 'test-section error';
            }
        }
    </script>
</body>
</html>